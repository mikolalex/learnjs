<!DOCTYPE html>
<html>
	<head>
		<title>Вивчи Javascript - заради добра, заради України!</title>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width">
		<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
		<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.3/styles/default.min.css">
		<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.3/highlight.min.js"></script>
		<script src="assert.js"></script>
	<style>

	pre {
	  overflow-x: auto;
	  overflow-y: hidden;
	margin: 30px 0px;
	margin-left: -30px;
	/* margin-right: -20px; */
	width: calc(100% + 100px);
	}
	
	h2, h3 {
		font-weight: normal;
		text-align: center;
	}

	.wrapper {
	  width: 900px;
	  margin: auto;
	}

	hr {
	  height: 1px; 
	  border: none;
	  border-top: 2px solid rgb(75, 75, 75);
	  border-bottom: 1px solid rgb(75, 75, 75);
	  margin: 40px 70px;
	}

	h1 {
	  font-weight: normal; 
	  margin-top: 80px;
	  margin-bottom: 30px;
	  padding-left: 110px;
	  padding-right: 80px;
	}

	body {
	  font-family:  Georgia; 
	  font-size: 16px;
	}

	.block {
	  border-style: solid;
	  border-width: 35px 10px 20px 80px;
	  padding: 50px 70px 40px 30px;
	  text-align: justify;
	  border-color: rgb(255, 236, 42); 
	  margin: 5px;
	  position: relative;
	}

	.block2 {
	  border-color: rgb(247, 54, 20); 
	}

	.block3 {
	  border-color: rgb(95, 118, 248);
	}
	
	.source {
		display: none;
	}
	
	pre {
		box-sizing: border-box;
	}
	
	code {
		box-sizing: border-box;
		font-size: 14px;
		padding: 30px !important;
	}
	
	footer {
		height: 150px;
	}
	
	p {
		text-indent: 20px;
	}
	
	li.disabled, li.disabled a {
		color: grey;
		cursor: default;
		text-decoration: none;
	}
	
	a {
		color: darkred;
	}
	
	li {
		margin: 15px;
	}
	
	.good, .bad {
		width: 100%;
		box-sizing: border-box;
		margin-top: 25px;
		position: relative;
	}
	
	.good:before {
		content: '✔ правильно';		
		background-color: rgb(255, 236, 42); 
		top: -15px;
		left: 15px;
		color: rgb(52, 52, 52);
		position: absolute;
		padding: 5px;
		box-shadow: 2px 2px 2px grey;
	}
	
	.bad:before {
		content: '✖ неправильно';		
		background-color: rgb(247, 54, 20);//  rgb(247, 54, 20);
		top: -15px;
		left: 15px;
		color: rgb(52, 52, 52);
		position: absolute;
		padding: 5px;
		box-shadow: 2px 2px 2px grey;
	}
	
	.test {
		width: 100%;
	}
	.test a span, .test a  {
		cursor: pointer;
		color: darkred;
		text-decoration: underline;
	}
	
	.test button span {
		color: black !important;
	}
	
	.test button {
		float: right;
		width: 100px;
		height: 30px;
	}
	
	.test input {
		height: 30px;
		display: block;
		float: left;
		box-sizing: border-box;
		width: calc(100% - 100px);
	}
	
	.check {
		padding: 10px;
	}
	
	.check.error {
		background-color: rgb(201, 30, 0);
		color: white;
		font-size: 20px;
	}
	
	.check.success {
		background-color: rgb(60, 138, 60);
		color: white;
		font-size: 20px;
	}
	
	.check.normal {
		background-color: whitesmoke;
		color: black;
		font-size: 20px;
		border: 1px dotted grey;
	}
	</style>
	</head>
	<body>
	<div class="wrapper"></div>
	<script>
	var ctrlDown = false;
	var ctrlKey = 17, vKey = 86, cKey = 67;	
		
	function escapeHtml(text) {
	  var map = {
	    '&': '&amp;',
	    '<': '&lt;',
	    '>': '&gt;',
	    '"': '&quot;',
	    "'": '&#039;'
		};

	  return text.replace(/[&<>"']/g, function(m) { return map[m]; });
	}
	
	var codes = [];
	var ra = [];
	var active_butt = false;
	
	var fail = function(txt){
		active_butt.find('.check').remove();
		$("<div />").addClass('check').addClass('error').text((txt || 'Невірно')).css('opacity', 0).appendTo(active_butt).animate({opacity: 1}, 500);
		//active_butt.append('<div class="check error">Невірно</div>').delay(3000)//.find('.check-error').hide();
	}
	var normal = function(txt){
		active_butt.find('.check').remove();
		if(txt) txt = txt
			.replace(/\&lt;/g, '<')
			.replace(/\&gt;/g, '>')
			.replace(/\&quot\;/g, '"')
			.replace(/\&#039\;/g, "'");
		$("<div />").addClass('check').addClass('normal').text((txt || 'Це дуже просто!')).css('opacity', 0).appendTo(active_butt).animate({opacity: 1}, 500);
		//active_butt.append('<div class="check error">Невірно</div>').delay(3000)//.find('.check-error').hide();
	}
	var success = function(){
		active_butt.find('.check').remove();
		$("<div />").addClass('check').addClass('success').text('Правильно!').css('opacity', 0).appendTo(active_butt).animate({opacity: 1}, 500);
	}
	
		var process_text = function(str){
			
			var regs = [
				['\#\#\#([^\n^\r]*)', '<h1>$1</h1>'],
				['\#\#([^\n^\r]*)', '<h2>$1</h2>'],
				['\n(\t*)\n(\t*)\n(\t*)\n', '<hr />'],
				['\\|([^\s^\|]{1,})\\|', '<b>$1</b>'],
				['@@@([^@]*)@@@', '<div class="block"><p>$1</p></div>'],
				['\\^([^\^]*)\\^([^\^]*)\\^', '<div><div class="bad"><pre><code class="js">$1</code></pre></div> <div class="good"><pre><code class="js">$2</code></pre></div><div style="clear:both;"></div></div>'],
				['```([^`]*)```', function(match, m1){ return '<pre><code class="js">' + escapeHtml(m1) + '</code></pre>'}],
				['\n(\t*)\n(\t*)\n', '</p><p>'],
				['\n(\t*)\n', '<br><br>'],
				['\\?\\?\\?\\%([^\%]*)\\%(([^\%^\n]*)\%)?', function(xxx, m1, m2, right_answer){
						console.log('m1', arguments);
						codes.push(m1);
						ra.push(right_answer);
						var ind = codes.length - 1;
						return '<div class="test"><input type="text" placeholder="Введіть свій код сюди..." /><button type="check" data-i="' + ind + '">перевірити!</button><div style="clear:both;text-align:center"><a class="surrender" data-i="' + ind + '">Здаюсь, показажіть правильну відповідь</a></div></div>';
					}],
			]
			
			for(var i in regs){
				var r = new RegExp(regs[i][0], 'g');
				str = str.replace(r, regs[i][1]);
			}
			

			return str;
		}

		
		
		$.get('text.txt', function(txt){
			$(".wrapper").html(process_text(txt));
			$('code').each(function(i, block) {
				hljs.highlightBlock(block);
			});

			var toc = [];
			$(".wrapper h2").each(function(){
				toc.push($(this).html());
			})

			for(var i = 1; i < toc.length; i++){
				$("#zmist").append('<li>' + toc[i] + '</li>');
			}

			$("#zmist").append('<li> ...далі буде</li>');

			$(".wrapper").on('click', 'a.surrender', function(){
				var ind = $(this).attr('data-i');
				active_butt = $(this).closest('.test');
				normal(ra[ind]);

			})

			$(".wrapper").on('click', 'button[type=check]', function(){
				active_butt = $(this).parent();
				var ind = $(this).attr('data-i');
				var assert = codes[ind]
					.replace(/\&quot\;/g, '"')
					.replace(/\&#039\;/g, "'")
					.replace(/\&lt;/g, '<')
					.replace(/\&gt;/g, '>');
				var user_code = $(this).prev().val();
				var parent = $(this).closest('code').text()
					.replace($(this).text(), '')
					.replace($(this).closest('code').find('a').text(), '')
					.replace($(this).closest('code').find('.check').text(), '')

				var code = '\
					(function(){\n\
						' +parent + ' \n\
						try { \n\
							' + user_code + ' \n\
							if(!(' + assert + ')){ fail(); } else { success(); }\n\
							\n\
						} catch(e){\n\
							console.log(e);\n\
							fail(); \n\
						}\n\
					})()';
				$("<script" + " />").html(code).appendTo('.wrapper');
				//$(".wrapper").append('<script>' + code + '</s' + 'cript>');
			})

			$(".wrapper").on('paste', ".test input[type=text]", function(e){
				active_butt = $(this).closest('.test');
				fail('Копіпаста заборонена!'); 
				return false;
			});
		})
		
	</script>
	<footer>
		
	</footer>
	</body>
</html>
